name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ==========================
    # 1. Checkout código
    # ==========================
    - name: Checkout code
      uses: actions/checkout@v4

    # ==========================
    # 2. Configuración SSH
    # ==========================
    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    # ==========================
    # 3. Deploy en el servidor
    # ==========================
    - name: Deploy via SSH
      run: |
        ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e

          echo "🚀 Entrando al directorio del proyecto..."
          cd /home/softgenix/htdocs/www.softgenix.space

          echo "📥 Actualizando código..."
          git pull origin main

          echo "🐳 Actualizando contenedores..."
          docker-compose down
          docker-compose build --no-cache
          docker-compose up -d

          echo "📦 Ejecutando composer install..."
          docker exec laravel_app composer install --no-dev --optimize-autoloader

          echo "📦 Ejecutando npm install & build..."
          docker exec laravel_app npm install --legacy-peer-deps
          docker exec laravel_app npm run build

          echo "⚙️  Ejecutando migraciones..."
          docker exec laravel_app php artisan migrate --force

          echo "🔗 Creando symlink de storage..."
          docker exec laravel_app php artisan storage:link || true

          echo "🚀 Cacheando configuración..."
          docker exec laravel_app php artisan config:cache
          docker exec laravel_app php artisan route:cache
          docker exec laravel_app php artisan view:cache

          echo "✅ Deploy completado con éxito!"
        EOF
