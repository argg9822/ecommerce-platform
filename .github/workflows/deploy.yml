name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy via SSH
      run: |
        ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e  # Exit on error
          cd /home/softgenix/htdocs/www.softgenix.space
          
          echo "ðŸ”„ Pulling latest code..."
          git pull origin main
          
          echo "ðŸ“¦ Installing PHP dependencies..."
          docker exec laravel_app composer install --no-dev --optimize-autoloader
          
          echo "ðŸ“¦ Installing NPM dependencies..."
          docker exec laravel_app npm ci
          
          echo "ðŸ—ï¸ Building frontend assets..."
          docker exec laravel_app npm run build
          
          echo "ðŸ³ Restarting containers..."
          docker-compose down
          docker-compose up -d --build
          
          echo "â³ Waiting for containers to be ready..."
          sleep 30
          
          echo "ðŸ”„ Clearing Laravel caches..."
          docker exec laravel_app php artisan config:clear
          docker exec laravel_app php artisan route:clear
          docker exec laravel_app php artisan view:clear
          docker exec laravel_app php artisan cache:clear
          
          echo "âš¡ Optimizing Laravel..."
          docker exec laravel_app php artisan config:cache
          docker exec laravel_app php artisan route:cache
          docker exec laravel_app php artisan view:cache
          
          echo "ðŸ—ƒï¸ Running database migrations..."
          docker exec laravel_app php artisan migrate --force
          
          echo "ðŸ¢ Running tenant migrations..."
          docker exec laravel_app php artisan tenants:migrate --force
          
          echo "ðŸ”§ Fixing permissions..."
          docker exec laravel_app chown -R www-data:www-data storage bootstrap/cache
          docker exec laravel_app chmod -R 775 storage bootstrap/cache
          
          echo "âœ… Deployment completed successfully!"
        EOF